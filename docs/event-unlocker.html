<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <title>Event Rewards Unlocker</title>
  <style>
    img { max-width: 100%; }
    .images { display: none; }
    body.show-images .images { display: block; }
    .technical { display: none; }
    body.show-technical .technical { display: block; }
  </style>
  </head>
  <body>
<div class="container"><div class="row"><div class="col">

<div class="card my-4"><div class="card-body">
  <h2>Event Rewards Unlocker</h2>
  <p>The progress of the event rewards is saved locally on your computer. That means if you install the game on another computer - your rewards will be lost. But it also means you can easily unlock them with this tool, no matter if you play on Windows, Mac or Linux.</p>
  <p>Click on the "Browse" button below, navigate to <code>Documents</code>, <code>Electronic Arts</code>, <code>The Sims 4</code>*, and select the <code>UserSetting.ini</code> file. It may be displayed as just <code>UserSetting</code>. Your browser will prompt you to download a modified file. Simply replace the file you selected with the one downloaded from here. After that everything should be unlocked.</p>
  <p><input type="file" class="form-control-file" accept=".ini"></p>
  <span>* in some languages this folder is named differently, like <code>Die Sims 4</code>, <code>Les Sims 4</code>, <code>Los Sims 4</code>, etc.</span>
</div><div class="card-footer">
  <span>To quickly find the event rewards in game you can use the "Special" &gt; "Event Rewards" filter.</span>
</div></div>

<div class="card my-4"><div class="card-body">
  <h2>Unlocked items:</h2>
  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="images">
    <label class="form-check-label" for="images">Show images</label>
  </div>
  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="technical">
    <label class="form-check-label" for="technical">Show technical information</label>
  </div>
  <div><b>Happy at Home Login Event</b> (June 2024) - Bullseye Dartboard, Night Sky Layered Necklace, Guerdon Goods Mini Fridge, Guerdon Goods NanoCan, Serenity Hairstyle, The Cool & Compact Bar, The Pure Pillow, Practice Makes Perfect trait, Athleisure Wear, Guerdon Goods Vending Machine</div>
  <div class="images"><img src="https://drop-assets.ea.com/images/5UEUnrwLRxbrhu46BZpTYb/1c3ea9787957c70989b8756aab4065d2/Juniper_happyathome_v2_EN.png"></div>
  <div class="technical">Adds/edits entries with a key ending with <code>#c7d81aab4d3f4d7a</code> and <code>#203fe3cf6b86bf0b</code>.</div>
</div><div class="card-footer"></div></div>

</div></div></div>

<script>

const OVERRIDES = {
  "c7d81aab4d3f4d7a": "AQAAAH8AAABLWOznT1IknfDKBly41qIbWyjuzVe6qhNhO87Id1K9OEwt5t1Hors6RQ3h/a+1ohJbKO7NV7qqE2Exzst3Ur04Ry/i1fNnpDhHL+LV8mekOEcv4tXxZ6Q4Ry/i1fRnpDhHL+LV8GekOEcv4tX/Z6Q4Ry/i1f5npDhHS0VZ+5xX",
  "203fe3cf6b86bf0b": "AQAAADAAAABLIe5+mqy4HkmRO9tNvrqvnDPsyU8MbwxLIe56mqy4HkmdO9tNvrqjnDPsyU8Abww="
};

// read file (blob) as text or array buffer asynchronously
const readAs = (file, type) => new Promise(resolve => {
  let reader = new FileReader();
  reader.onload = e => {
    resolve(e.target.result);
  };
  if(type == "text")
    reader.readAsText(file);
  else
    reader.readAsArrayBuffer(file);
});

const downloadBlob = (blob, name) => {
  const link = document.createElement("a");
  const url = window.URL.createObjectURL(blob);
  link.href = url;
  link.download = name;
  document.body.appendChild(link);
  link.click();
  window.URL.revokeObjectURL(url);
  link.remove();
};

document.querySelector("input").addEventListener("change", async e => {
  const file = e.target.files[0];
  const text = await readAs(file, "text");
  const crlf = text.includes("\r\n");

  if(file.name.toLowerCase() !== "usersetting.ini") {
    alert("the file you selected isn't named UserSetting.ini, make sure you select the right file");
    return;
  }

  const ini = {};
  let group = "";
  for(const line of text.split(/\r?\n/)) {
    if(line.length == 0) {
      continue;
    }

    let m = line.match(/^\s*\[(.*?)\]\s*$/);
    if(m !== null) {
      group = m[1];
      if(typeof ini[group] === "undefined") {
        ini[group] = {};
      }
    }
    else {
      m = line.match(/^\s*(.*?)\s*=\s*(.*?)\s*$/);
      if(m === null) {
        alert("invalid line, it will be skipped: " + line);
        continue;
      }
      if(group === "") {
        alert("value without a group, this line will be skipped: " + line);
        continue;
      }
      ini[group][m[1]] = m[2];
    }
  }

  if(typeof ini["uiaccountsettings"] === "undefined") {
    alert("no user settings found, run the game at least once")
    return;
  }

  const userIDs = new Set();
  for(const ID of Object.keys(ini["uiaccountsettings"])) {
    userIDs.add(ID.split("#")[0]);
  }

  for(const [k, v] of Object.entries(OVERRIDES)) {
    for(const ID of userIDs) {
      ini["uiaccountsettings"][ID + "#" + k] = v;
    }
  }

  const lines = [];
  for(const [group, values] of Object.entries(ini)) {
    lines.push("[" + group + "]");
    for(const [k, v] of Object.entries(values)) {
      lines.push(k + " = " + v);
    }
  }
  lines.push("");

  const separator = (crlf ? "\r\n" : "\n");
  const newText = lines.join(separator);

  downloadBlob(new Blob([newText]), "UserSetting.ini");
});

const checkboxClick = event => {
  const checkbox = event.target;
  document.body.classList[checkbox.checked ? "add" : "remove"](`show-${checkbox.id}`);
};

for(const el of document.querySelectorAll('input[type="checkbox"]')) {
  el.addEventListener("click", checkboxClick);
}

</script>
</body></html>
